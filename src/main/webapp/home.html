<html>
    <head>
        <title>Home</title>
    </head>
    <body>
        <h3>Enter race</h3>
        <form method="GET" action="/api/tracker" onsubmit="return enroll();">
            <fieldset>
                <label for="raceId">Select race</label>
                <select id="raceId" name="raceId"></select><br/>

                <label for="searchName">Last name</label>
                <input id="searchName" name="searchName" onchange="searchParticipants();" /><br/>
                
                <label for="extUserId">Participant</label>
                <select id="extUserId" name="extUserId"></select><br/>

                <input type="submit" value="Enter Race" />
            </fieldset>
        </form>
        <h3>Registered races</h3>
        <table>
            <thead>
                <tr>
                    <th>raceId</th><th>fitness actionId</th><th>Edit</th>
                </tr>
            </thead>
            <tbody id="racesBody"></tbody>
        </table>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="/js/crud_api.js"></script>
        <script type="text/javascript">
function searchParticipants() {
    var searchName = $("#searchName").val();
    var raceId = $("#raceId").val();
    $.getJSON("/api/tracker/search/" + raceId +
        "?searchName=" + searchName)
    .done(function(data, statusText, jqXHR) {
        $("#extUserId").html("");
        $.each(data, function(index, item) {
            $("#extUserId").append('<option value="' + item.value + 
                '">' + item.key + '</option>');
        });
    });
}
            
function loadMyRaces() {
    $("#racesBody").html("");
    crud_Read("api/participant", "me")
    .done(function(data, statusText, jqXHR) {
        $.each(data, function(index, item) {
            $("#racesBody").append("<tr><td>" +
                item.raceId + "</td><td>" + item.actionId + 
                "</td><td><a href='splits.html?raceId=" + item.raceId + 
                "&participantId=" + item.id + "'>" + item.actionId + 
                "</a></td></tr>");
        });
    });
}
    
function enroll() {
    crud_Read("api", "tracker?raceId=" + $("#raceId").val() + 
            "&extUserId=" + $("#extUserId").val())
    .done(function(data, statusText, jqXHR) {
        loadMyRaces();
    });

    return false;
}            

$(function() {
    // populate race dropdown
    crud_Read("pub", "course")
    .done(function(data, statusText, jqXHR) {
        $.each(data, function(index, item) {
            $("#raceId").append('<option value="' +
                item.id + '">' + item.displayName + 
                '</option>');
        });
    });
    
    // populate search name field
    crud_Read("api/oauth2user", "me")
    .success(function(data) {
        var beginIndex = data.displayName.lastIndexOf(' ');
        var lastName = data.displayName.substr(beginIndex+1);
        $("#searchName").val(lastName);
        searchParticipants();
    });

    loadMyRaces();
    
    $("#searchName").focus();
});
        </script>
    </body>
</html>